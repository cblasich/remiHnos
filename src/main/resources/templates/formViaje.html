<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
	<head th:replace="layout/layout :: head">
		<meta charset="UTF-8" />
	</head>
	<body class="fondo-color">
		<header th:replace="layout/layout :: headerCli"></header> 		 
		<script>
			var platform = new H.service.Platform({
				  'apikey': 'oxDnzd008W-4IKY8yfiTOjpXF5moBSPKZVwBYa2jyr0'
				});
			// Obtain the default map types from the platform object:
			var defaultLayers = platform.createDefaultLayers();
		</script>
		
		<div class="containerSinMargen">
			<p></p>
			<p></p>
			<form th:action="@{/formViaje}" th:object="${viaje}" method="post">
				<div class="row separacion4">
					<div class="col-1 col-sm-1 col-form-label d-none">&nbsp; </div>	
				</div>
				<div class="row">
					<div class="col-1 d-sm-none"></div>
					<label class="col-4 col-sm-1 col-form-label">Origen </label>
					<div class="col-sm-11 d-none"></div>
				</div>	
				<div class="form-group row">
					<div class="col-1 d-sm-none"></div>
					<div class="col-10 col-sm-3">
						<input id="OriCalle" type="text" th:field="*{ViaCalleOri}" class="form-control" placeholder="Calle" required/>
						<small class="form-text text-danger" th:if="${#fields.hasErrors('ViaCalleOri')}" th:errors="*{ViaCalleOri}"></small>
					</div>
				</div>	
				<div class="form-group row">
					<div class="col-1 d-sm-none"></div>
					<div class="col-10 col-sm-3">
						<input id="OriNum" type="number" th:field="*{ViaNumOri}" class="form-control" placeholder="Altura" required/>
						<small class="form-text text-danger" th:if="${#fields.hasErrors('ViaNumOri')}" th:errors="*{ViaNumOri}"></small>
					</div>
				</div>	
				<div class="row">
					<div class="col-1 d-sm-none"></div>
					<label class="col-4 col-sm-1 col-form-label">Destino </label>
					<div class="col-sm-11 d-none"></div>
				</div>	
				<div class="form-group row">
					<div class="col-1 d-sm-none"></div>
					<div class="col-10 col-sm-3">
						<input id="DesCalle" type="text" th:field="*{ViaCalleDes}" class="form-control" placeholder="Calle" />
						<small class="form-text text-danger" th:if="${#fields.hasErrors('ViaCalleDes')}" th:errors="*{ViaCalleDes}"></small>
					</div>
				</div>	
				<div class="form-group row">
					<div class="col-1 d-sm-none"></div>
					<div class="col-10 col-sm-3">
						<input id="DesNum" type="number" th:field="*{ViaNumDes}" class="form-control" placeholder="Altura" />
						<small class="form-text text-danger" th:if="${#fields.hasErrors('ViaNumDes')}" th:errors="*{ViaNumDes}"></small>
					</div>
				</div>
				
				<input type="hidden" id="bajban" th:value="${viaje.Tarifa.TarBajBan}"/>
				<input id="pre100m" th:value="${viaje.Tarifa.TarImp100m}"/>
				<input id="monEst" th:field="*{ViaMonEst}"/> 
				
				
				<!-- ESTO PONER EN UN MODAL -->
				<div id="rowMapa" class="row altura-15 d-none">
				<div class="col-1 col-sm-4"></div>   
					<div id="mapContainer" class="col-10 col-sm-4" style="position: relative; overflow: hidden;">  <!-- style="position: relative; overflow: hidden;" -->
	   	 			</div>
	   	 		</div>
				
				<div class="form-group row">
					<div class="col-1 d-sm-none">&nbsp;</div>
					<div id="btnVerPrecio" class="col-10 col-sm-3 text-center">
						<button type="button" class="btn btn-primary">Ver precio estimado</button>
						<input type="hidden" />
					</div>
					<div class="col-1 ">&nbsp;</div>
				</div>
				
				<div class="row">
					<div class="col-1 d-sm-none"></div>
					<label class="col-4 col-sm-1 col-form-label">Teléfono</label>
				</div>
				<div class="form-group row">
					<div class="col-1 d-sm-none"></div>
					<div class="col-10 col-sm-3">
						<input type="number" th:field="*{ViaTelefono}" class="form-control" required/>
						<small class="form-text text-danger" th:if="${#fields.hasErrors('ViaTelefono')}" th:errors="*{ViaTelefono}"></small>
					</div>
				</div>
				
				<div class="row">
					<div class="col-1 d-sm-none"></div>
					<label class="col-4 col-sm-1 col-form-label">Forma de pago</label>
				</div>
				<div class="row">
					<div class="col-1 d-sm-none"></div>
					<div class="col-11 pb-3">
					<div class="col-11 pb-3">
						<input type="radio" name="medioPago" value="E" th:field="*{ViaForPag}" required> Efectivo<br>
						<input type="radio" name="medioPago" value="T" th:field="*{ViaForPag}" required> Tarjeta (vía Mercado Pago)<br>
					</div>
					</div>
				</div>
				<div class="row separacion1">
					<div class="col-1 col-sm-1 col-form-label">&nbsp; </div>	
				</div>	
				<div class="form-group row">
					<div class="col-1 d-sm-none">&nbsp;</div>
					<div class="col-10 col-sm-3 text-center">
						<button type="submit" class="btn btn-primary">Confirmar</button>
						<input type="hidden" th:field="*{ViaId}" />
						
					</div>
					<div class="col-1 ">&nbsp;</div>
				</div>
			</form>
		</div>
		<script>
			// Initialize the service
			var dire;
			var ok;
			var oricalle;
			var orinum;
			var descalle;
			var desnum;
			var direOri;
			var direDes;
			
			const geocoderService = platform.getGeocodingService();	
			const routerService = platform.getRoutingService();
			
			const geocoder = query => {
				return new Promise((resolve, reject) => {
					geocoderService.geocode(
						{
							"searchtext": query
						},
						success => {
							resolve(success.Response.View[0].Result[0].Location.DisplayPosition);
						},
						error => {
							reject(error);
						}
					);
				});
			}
			
			const calculateRoute = (start, finish) => {
				return new Promise((resolve,reject) => {
					const params = {
						mode: "fastest;car;traffic:enabled",
						waypoint0: start.Latitude + "," + start.Longitude,
						waypoint1: finish.Latitude + "," + finish.Longitude,
						representation: "display",
						routeAttributes: "summary"
					};
				 	routerService.calculateRoute(params, success => {
				 		resolve(success.response.route[0].shape);
				 	}, error => {
				 		reject(error);
				 	});
				});		
			}
			
			const calculateDistance = (start, finish) => {
				return new Promise((resolve,reject) => {
					const params = {
						mode: "fastest;car;traffic:enabled",
						waypoint0: start.Latitude + "," + start.Longitude,
						waypoint1: finish.Latitude + "," + finish.Longitude,
						representation: "display",
						routeAttributes: "summary"
					};
				 	routerService.calculateRoute(params, success => {
				 		resolve(success.response.route[0].summary.distance);
				 	}, error => {
				 		reject(error);
				 	});
				});		
			}
			
			const start = async () => {
				document.getElementById("mapContainer").innerHTML="";
				dire = "Formosa, Argentina";
				const origen = await geocoder(direOri);
				const destino = await geocoder(direDes);
				// Instantiate (and display) a map object:
				const map = new H.Map(
				    document.getElementById('mapContainer'),
				    defaultLayers.vector.normal.map,
				    {
				      zoom: 12,
				      center: { lat: origen.Latitude, lng: origen.Longitude }     //center: { lat: -26.17, lng: -58.17 }   
				    }
			    );
				const mapEvents = new H.mapevents.MapEvents(map);
				const behavior = new H.mapevents.Behavior(mapEvents);
				//marcadores punto origen y destino
				const origenMarker = new H.map.Marker({ lat: origen.Latitude , lng: origen.Longitude });
				const destinoMarker = new H.map.Marker({ lat: destino.Latitude , lng: destino.Longitude });
				//ruta entre puntos
				const ruta = await calculateRoute(origen, destino);
				const rutaLineString = new H.geo.LineString();
				ruta.forEach(points => {
					let parts = points.split(",");
					rutaLineString.pushPoint({
						lat: parts[0],
						lng: parts[1]
					});
				});
				const rutaPolyline = new H.map.Polyline(
					rutaLineString,
					{
						style: {
							lineWidth: 6
						}
					}
				);
				
				const distance = await calculateDistance(origen, destino);
				//console.log(distance);
				
				map.addObjects([origenMarker,destinoMarker,rutaPolyline]);
				var pre100m = $("#pre100m").val();
				var bajban = $("#bajban").val();
				var preEst = bajban+(pre100m*distance);
				//
				//alert("El precio de los 100 mt es "+pre100m);
				//alert("La bajada de bandera es "+bajban);
				//alert("La distancia entre puntos es "+distance);
				alert("El precio estimado es"+preEst);
				document.getElementById("monEst").value = preEst;
			}
		
			$("#btnVerPrecio").click(function() {
				ok = 1;
				ValidarOriDes();
				if (ok==0) { 
					alert("Faltan datos de origen y destino."); 
				} else {
						direOri = oricalle.concat(' ',orinum,' , Formosa, Argentina');
						//alert("Direccion de origen: "+direOri);
						
						direDes = descalle.concat(' ',desnum,' , Formosa, Argentina');
						//alert("Direccion destino: "+direDes);
		
						start();
				}
				
			});
			
			function ValidarOriDes() {
				oricalle = $.trim($("#OriCalle").val());
				orinum = $.trim($("#OriNum").val());
				descalle = $.trim($("#DesCalle").val());
				desnum = $.trim($("#DesNum").val());
				
				if(oricalle == '' || oricalle == null){
				  	$("#OriCalle").val(null);
				  	ok = 0;
				}
				if(orinum == '' || orinum == null){
				  	$("#OriCalle").val(null);
				  	ok = 0;
				}
				if(descalle == '' || descalle == null){
				  	$("#OriCalle").val(null);
				  	ok = 0;
				}
				if(desnum == '' || desnum == null){
				  	$("#OriCalle").val(null);
				  	ok = 0;
				}
				return ok;
			}
			
		</script>
	</body>
</html>