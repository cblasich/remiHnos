<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
	<head th:replace="layout/layout :: head">
		<meta charset="UTF-8" />
	</head>
	<body class="fondo-color">
		<header th:replace="layout/layout :: headerCli"></header> 		 
		<script>
			var platform = new H.service.Platform({
				  'apikey': 'oxDnzd008W-4IKY8yfiTOjpXF5moBSPKZVwBYa2jyr0'
				});
			// Obtain the default map types from the platform object:
			var defaultLayers = platform.createDefaultLayers();
		</script>
		
		<div class="container" id="contPpal"> 
			<p></p>
			<p></p>
			<form th:action="@{/formViaje}" th:object="${viaje}" method="post">
				<div id="espacioSup" class="row separacion1">
					<div class="col-1 col-sm-1 col-form-label d-none">&nbsp; </div>	
				</div>
				<div id="contOrigen">
					<div class="row">
						<div class="col-1 d-sm-none"></div>
						<label class="col-4 col-sm-1 col-form-label">Origen </label>
						<div class="col-sm-11 d-none"></div>
					</div>	
					<div class="form-group row">
						<div class="col-1 d-sm-none"></div>
						<div class="col-10 col-sm-3">
							<input id="OriCalle" type="text" th:field="*{ViaCalleOri}" class="form-control" placeholder="Calle" required/>
							<small class="form-text text-danger" th:if="${#fields.hasErrors('ViaCalleOri')}" th:errors="*{ViaCalleOri}"></small>
							<small id="errOriCalle" class="form-text text-danger d-none">Debe indicar calle del origen.</small>
						</div>
					</div>	
					<div class="form-group row">
						<div class="col-1 d-sm-none"></div>
						<div class="col-10 col-sm-3">
							<input id="OriNum" type="number" th:field="*{ViaNumOri}" class="form-control" placeholder="Altura" required/>
							<small class="form-text text-danger" th:if="${#fields.hasErrors('ViaNumOri')}" th:errors="*{ViaNumOri}"></small>
							<small id="errOriNum" class="form-text text-danger d-none">Debe indicar altura del origen.</small>
						</div>
					</div>	
				</div>
				<div id="contDestino">
					<div class="row">
						<div class="col-1 d-sm-none"></div>
						<label class="col-4 col-sm-1 col-form-label">Destino </label>
						<div class="col-sm-11 d-none"></div>
					</div>	
					<div class="form-group row">
						<div class="col-1 d-sm-none"></div>
						<div class="col-10 col-sm-3">
							<input id="DesCalle" type="text" th:field="*{ViaCalleDes}" class="form-control" placeholder="Calle" />
							<small class="form-text text-danger" th:if="${#fields.hasErrors('ViaCalleDes')}" th:errors="*{ViaCalleDes}"></small>
							<small id="errDesCalle" class="form-text text-danger d-none">Debe indicar calle del destino. </small>
						</div>
					</div>	
					<div class="form-group row">
						<div class="col-1 d-sm-none"></div>
						<div class="col-10 col-sm-3">
							<input id="DesNum" type="number" th:field="*{ViaNumDes}" class="form-control" placeholder="Altura" />
							<small class="form-text text-danger" th:if="${#fields.hasErrors('ViaNumDes')}" th:errors="*{ViaNumDes}"></small>
							<small id="errDesNum" class="form-text text-danger d-none">Debe indicar altura del destino.</small>
						</div>
					</div>
				</div>
				
				<div id="contMapa" class="container d-none shadow p-3 mb-5 rounded"> 
					<div id="rowMapa" class="row altura-30 quitaMargRL">
						<div class="col-1 col-sm-4 "></div>   
						<div id="mapContainer" class="col-10 col-sm-4 pb-4" style="position: relative; overflow: hidden;"> </div>
		   	 		</div>  
		   	 		<div class="row">
						<div class="col-1 d-sm-none"></div>
						<label id="lblOrigen" class="col-10 col-sm-1"> </label>
						<div class="col-sm-11 d-none"></div>
					</div>	
					<div class="row">
						<div class="col-1 d-sm-none"></div>
						<label id="lblDestino" class="col-10 col-sm-1"> </label>
						<div class="col-sm-11 d-none"></div>
					</div>	
					<div class="row">
						<div class="col-1 d-sm-none"></div>
						<label id="lblMonEst" class="col-10 col-sm-1"> </label>
						<input id="monEst" type="hidden" class="d-none" th:field="*{ViaMonEst}"/> 
						<div class="col-sm-11 d-none"></div>
					</div>	
					<div class="row">
						<div class="col-1 d-sm-none"></div>
						<label class="col-8 col-sm-1"> </label>
						<button type="button" id="btnModif" class="col-2 col-sm-1 btn btn-success">Modificar</button>
						<div class="col-sm-11 d-none"></div>
					</div>	
				</div>
				
				<div class="row">
					<div class="col-1 d-sm-none"></div>
					<label class="col-4 col-sm-1 col-form-label">Teléfono</label>
				</div>
				<div class="form-group row">
					<div class="col-1 d-sm-none"></div>
					<div class="col-10 col-sm-3">
						<input type="number" th:field="*{ViaTelefono}" class="form-control" required/>
						<small class="form-text text-danger" th:if="${#fields.hasErrors('ViaTelefono')}" th:errors="*{ViaTelefono}"></small>
					</div>
				</div>
				<div class="row">
					<div class="col-1 d-sm-none"></div>
					<label class="col-4 col-sm-2 col-form-label">Forma de pago</label>
				</div>
				<div class="row">
					<div class="col-1 d-sm-none"></div>
					<div class="col-11 pb-3">
					<div class="col-11 pb-3">
						<input type="radio" name="medioPago" value="E" th:field="*{ViaForPag}" required> Efectivo<br>
						<input type="radio" name="medioPago" value="T" th:field="*{ViaForPag}" required> Tarjeta (vía Mercado Pago)<br>
					</div>
					</div>
				</div>
				<input type="hidden" id="bajban" th:value="${viaje.Tarifa.TarBajBan}"/>
				<input type="hidden" id="pre100m" th:value="${viaje.Tarifa.TarImp100m}"/>
				
				<div class="row separacion1">
					<div class="col-1 col-sm-1 col-form-label">&nbsp; </div>	
				</div>	
				<div id="contBtnPreEst" class="form-group row">
					<div class="col-1 d-sm-none">&nbsp;</div>
					<div id="btnVerPrecio" class="col-10 col-sm-3 text-center">
						<button type="button" class="btn btn-primary" >Ver precio estimado</button>
						<input type="hidden" />
					</div>
					<div class="col-1 ">&nbsp;</div>
				</div>
				<div class="form-group row">
					<div class="col-1 d-sm-none">&nbsp;</div>
					<div class="col-10 col-sm-3 text-center">
						<button type="submit" class="btn btn-primary">Confirmar</button>
						<input type="hidden" th:field="*{ViaId}" />
						
					</div>
					<div class="col-1 ">&nbsp;</div>
				</div>
			</form>
		</div>
		
		<footer th:replace="layout/layout :: footer"></footer>
		<script>
			// Initialize the service
			var dire;
			var ok;
			var oricalle;
			var orinum;
			var descalle;
			var desnum;
			var direOri;
			var direDes;
			var pre100m;
			var bajban;
			var preEst;
			
			const geocoderService = platform.getGeocodingService();	
			const routerService = platform.getRoutingService();
			
			const geocoder = query => {
				return new Promise((resolve, reject) => {
					geocoderService.geocode(
						{
							"searchtext": query
						},
						success => {
							resolve(success.Response.View[0].Result[0].Location.DisplayPosition);
						},
						error => {
							reject(error);
						}
					);
				});
			}
			
			const calculateRoute = (start, finish) => {
				return new Promise((resolve,reject) => {
					const params = {
						mode: "fastest;car;traffic:enabled",
						waypoint0: start.Latitude + "," + start.Longitude,
						waypoint1: finish.Latitude + "," + finish.Longitude,
						representation: "display",
						routeAttributes: "summary"
					};
				 	routerService.calculateRoute(params, success => {
				 		resolve(success.response.route[0].shape);
				 	}, error => {
				 		reject(error);
				 	});
				});		
			}
			
			const calculateDistance = (start, finish) => {
				return new Promise((resolve,reject) => {
					const params = {
						mode: "fastest;car;traffic:enabled",
						waypoint0: start.Latitude + "," + start.Longitude,
						waypoint1: finish.Latitude + "," + finish.Longitude,
						representation: "display",
						routeAttributes: "summary"
					};
				 	routerService.calculateRoute(params, success => {
				 		resolve(success.response.route[0].summary.distance);
				 	}, error => {
				 		reject(error);
				 	});
				});		
			}
			
			const start = async () => {
				document.getElementById("mapContainer").innerHTML="";
				dire = "Formosa, Argentina";
				const origen = await geocoder(direOri);
				const destino = await geocoder(direDes);
				// Instantiate (and display) a map object:
				const map = new H.Map(
				    document.getElementById('mapContainer'),
				    defaultLayers.vector.normal.map,
				    {
				      zoom: 15,
				      center: { lat: origen.Latitude, lng: origen.Longitude }    
				    }
			    );
				const mapEvents = new H.mapevents.MapEvents(map);
				const behavior = new H.mapevents.Behavior(mapEvents);
				//marcadores punto origen y destino
				const origenMarker = new H.map.Marker({ lat: origen.Latitude , lng: origen.Longitude });
				const destinoMarker = new H.map.Marker({ lat: destino.Latitude , lng: destino.Longitude });
				//ruta entre puntos
				const ruta = await calculateRoute(origen, destino);
				const rutaLineString = new H.geo.LineString();
				ruta.forEach(points => {
					let parts = points.split(",");
					rutaLineString.pushPoint({
						lat: parts[0],
						lng: parts[1]
					});
				});
				const rutaPolyline = new H.map.Polyline(
					rutaLineString,
					{
						style: {
							lineWidth: 6
						}
					}
				);
				
				const distance = await calculateDistance(origen, destino);
				dist100 =  Math.ceil(distance/100);
				
				map.addObjects([origenMarker,destinoMarker,rutaPolyline]);
				pre100m = $("#pre100m").val();
				bajban = $("#bajban").val();
				preEst = Math.ceil(pre100m*dist100+parseFloat(bajban));
				console.log(bajban);
				console.log(pre100m);
				console.log(distance);
				console.log(dist100);
				console.log(preEst);
				document.getElementById("monEst").value = preEst;
				var cos = 'Costo estimado del viaje: $' + preEst + '.'; 
				$("#lblMonEst").text(cos);
			}
		
			$("#btnVerPrecio").click(function() {
				ok = 1;
				ValidarOriDes();
				if (ok==1) { 
					preEst = 0;
					direOri = oricalle.concat(' ',orinum,' , Formosa, Argentina');
					direDes = descalle.concat(' ',desnum,' , Formosa, Argentina');
					start();
					ori1 = 'Origen: ';
					ori2 = ori1.concat(oricalle,' ',orinum,'.');   
					des1 = 'Destino: ';
					des2 = des1.concat(descalle,' ',desnum,'.');
					
					$("#espacioSup").addClass("d-none d-sm-block");
					$("#contOrigen").addClass("d-none d-sm-block");
					$("#contDestino").addClass("d-none d-sm-block");
					$("#contBtnPreEst").addClass("d-none");  
					$("#lblOrigen").text(ori2);
					$("#lblDestino").text(des2);
					$("#contMapa").removeClass("d-none");
				} 
			});
			
			$("#btnModif").click(function() {
				$("#espacioSup").removeClass("d-none d-sm-block");
				$("#contOrigen").removeClass("d-none d-sm-block");
				$("#contDestino").removeClass("d-none d-sm-block");
				$("#contBtnPreEst").removeClass("d-none");  
				$("#contMapa").addClass("d-none");
			});
			
			function ValidarOriDes() {
				oricalle = $.trim($("#OriCalle").val());
				orinum = $.trim($("#OriNum").val());
				descalle = $.trim($("#DesCalle").val());
				desnum = $.trim($("#DesNum").val());
				
				if(oricalle == '' || oricalle == null){
				  	$("#OriCalle").val(null);
				  	ok = 0;
				  	$("#errOriCalle").removeClass("d-none");
				} else {
					$("#errOriCalle").addClass("d-none");
				}
				if(orinum == '' || orinum == null){
				  	$("#OriNum").val(null);
				  	ok = 0;
				  	$("#errOriNum").removeClass("d-none");
				} else {
					$("#errOriNum").addClass("d-none");
				}
				if(descalle == '' || descalle == null){
				  	$("#DesCalle").val(null);
				  	ok = 0;
				  	$("#errDesCalle").removeClass("d-none");
				} else {
					$("#errDesCalle").addClass("d-none");
				}
				if(desnum == '' || desnum == null){
				  	$("#DesNum").val(null);
				  	ok = 0;
				  	$("#errDesNum").removeClass("d-none");
				} else {
					$("#errDesNum").addClass("d-none");
				}
				return ok;
			}
		
		</script>
	</body>
</html>